<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Money Map</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
*{-webkit-tap-highlight-color:transparent}
body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow-x:hidden}
/* iPhoneç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å›ºå®š */
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:white;
  border-top:1px solid #e5e7eb;
  z-index:9999;
  padding-bottom:env(safe-area-inset-bottom);
}
/* ãƒ˜ãƒƒãƒ€ãƒ¼ - sticky ã§è‡ªç„¶ã«é…ç½® */
.header-sticky{
  position:sticky;
  top:0;
  left:0;
  right:0;
  z-index:9998;
  background:linear-gradient(to right, #fffbeb, #fef3c7);
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.main-content{
  padding-bottom:calc(80px + env(safe-area-inset-bottom));
}
.quick-expense-btn{
  position:fixed;
  bottom:calc(80px + env(safe-area-inset-bottom));
  right:16px;
  z-index:9998;
}
</style>
</head>
<body>
<div id="root"></div>
<script>
window.storage={
  get:async(k)=>{const v=localStorage.getItem(k);return v?{value:v}:null},
  set:async(k,v)=>{localStorage.setItem(k,v);return{key:k,value:v}}
};
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨æŠ‘åˆ¶
const noop = () => {};
console.warn = noop;
console.error = noop;
// å…ƒã®console.logã¯ä¿æŒï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã€æœ¬ç•ªã§ã¯å‰Šé™¤å¯èƒ½ï¼‰
</script>
<script type="text/babel">
const {useState,useEffect,useMemo,useCallback,useRef}=React;
const Home=()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>;
const Wallet=()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>;
const History=()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
const Settings=()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>;
const Edit2=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>;
const Zap=({className})=><svg className={className||"w-6 h-6"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>;
const Calendar=({className})=><svg className={className||"w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>;
const Info=({className})=><svg className={className||"w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
const PiggyBank=()=><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>;
const Heart=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>;
const TrendingUp=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>;
const AlertCircle=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
const Plane=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>;
const Star=({className})=><svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>;


// ========================================
// è²¯é‡‘ã‚«ãƒ†ã‚´ãƒªå®šç¾©
// ========================================
const SAVING_CATEGORIES = {
  oshikatsu: {
    name: 'æ¨ã—æ´»',
    color: 'pink',
    bgColor: 'bg-pink-50',
    borderColor: 'border-pink-200',
    textColor: 'text-pink-600',
    progressColor: 'from-pink-400 to-rose-400',
    icon: Heart,
  },
  investment: {
    name: 'æŠ•è³‡ãƒ»NISA',
    color: 'emerald',
    bgColor: 'bg-emerald-50',
    borderColor: 'border-emerald-200',
    textColor: 'text-emerald-600',
    progressColor: 'from-emerald-400 to-teal-400',
    icon: TrendingUp,
  },
  emergency: {
    name: 'ç·Šæ€¥ç”¨',
    color: 'orange',
    bgColor: 'bg-orange-50',
    borderColor: 'border-orange-200',
    textColor: 'text-orange-600',
    progressColor: 'from-orange-400 to-amber-400',
    icon: AlertCircle,
  },
  travel: {
    name: 'æ—…è¡Œ',
    color: 'sky',
    bgColor: 'bg-sky-50',
    borderColor: 'border-sky-200',
    textColor: 'text-sky-600',
    progressColor: 'from-sky-400 to-blue-400',
    icon: Plane,
  },
  other: {
    name: 'ãã®ä»–',
    color: 'purple',
    bgColor: 'bg-purple-50',
    borderColor: 'border-purple-200',
    textColor: 'text-purple-600',
    progressColor: 'from-purple-400 to-violet-400',
    icon: Star,
  },
};

// ========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
// ========================================
const useBudgetCalculation = (data) => {
  const totalBalance = useMemo(() => {
    if (!data.accounts || data.accounts.length === 0) return 0;
    return data.accounts.reduce((sum, account) => {
      if (!account.buckets || account.buckets.length === 0) return sum;
      return sum + account.buckets.reduce((bucketSum, bucket) => {
        return bucketSum + (Number(bucket.balance) || 0);
      }, 0);
    }, 0);
  }, [data.accounts]);

  const totalFixedExpenses = useMemo(() => {
    if (!data.fixedExpenses || data.fixedExpenses.length === 0) return 0;
    return data.fixedExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
  }, [data.fixedExpenses]);

  const fixedExpensesFromIncome = useMemo(() => {
    if (!data.fixedExpenses || data.fixedExpenses.length === 0) return 0;
    return data.fixedExpenses
      .filter(expense => expense.payFrom === 'income')
      .reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
  }, [data.fixedExpenses]);

  const totalSavings = useMemo(() => {
    if (!data.savings || data.savings.length === 0) return 0;
    return data.savings.reduce((sum, saving) => sum + (Number(saving.monthlyAmount) || 0), 0);
  }, [data.savings]);

  const savingsFromIncome = useMemo(() => {
    if (!data.savings || data.savings.length === 0) return 0;
    return data.savings
      .filter(saving => saving.payFrom === 'income')
      .reduce((sum, saving) => sum + (Number(saving.monthlyAmount) || 0), 0);
  }, [data.savings]);

  const deductFromIncome = useMemo(() => {
    return fixedExpensesFromIncome + savingsFromIncome;
  }, [fixedExpensesFromIncome, savingsFromIncome]);

  const remainingMoney = useMemo(() => {
    const income = Number(data.monthlyIncome) || 0;
    return income - deductFromIncome;
  }, [data.monthlyIncome, deductFromIncome]);

  const remainingDays = useMemo(() => {
    const today = new Date();
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    return lastDay.getDate() - today.getDate() + 1;
  }, []);

  const dailyBudget = useMemo(() => {
    if (remainingDays <= 0) return 0;
    return Math.floor(remainingMoney / remainingDays);
  }, [remainingMoney, remainingDays]);

  return {
    totalBalance,
    totalFixedExpenses,
    fixedExpensesFromIncome,
    totalSavings,
    savingsFromIncome,
    deductFromIncome,
    remainingMoney,
    remainingDays,
    dailyBudget,
  };
};

// ========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯: è‡ªå‹•ä¿å­˜
// ========================================
const useAutoSave = (data, storageKey = 'budgetData', delay = 500) => {
  const timeoutRef = useRef(null);
  const isFirstRender = useRef(true);

  useEffect(() => {
    if (isFirstRender.current) {
      isFirstRender.current = false;
      return;
    }

    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    timeoutRef.current = setTimeout(async () => {
      try {
        await window.storage.set(storageKey, JSON.stringify(data));
      } catch (error) {
        // window.storageãŒå¤±æ•—ã—ãŸã‚‰localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
        } catch (fallbackError) {
          // ä¸¡æ–¹å¤±æ•—ã—ãŸã‚‰é™ã‹ã«ç„¡è¦–ï¼ˆArtifactã®åˆ¶é™ãªã©ï¼‰
        }
      }
    }, delay);

    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [data, storageKey, delay]);
};

// ========================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯: çµ¦æ–™æ—¥ç®¡ç†
// ========================================
const usePaydayManagement = (data, setData) => {
  const [shouldShowResetModal, setShouldShowResetModal] = useState(false);
  const [nextPayday, setNextPayday] = useState(null);

  // æœˆæœ«æœ€çµ‚å¹³æ—¥ã‚’è¨ˆç®—ï¼ˆåœŸæ—¥ã‚’é¿ã‘ã‚‹ï¼‰
  const getLastBusinessDayOfMonth = useCallback((year, month) => {
    let lastDay = new Date(year, month + 1, 0); // æœˆæœ«
    const dayOfWeek = lastDay.getDay();
    
    // åœŸæ›œæ—¥(6)ãªã‚‰é‡‘æ›œæ—¥ã«ã€æ—¥æ›œæ—¥(0)ãªã‚‰é‡‘æ›œæ—¥ã«
    if (dayOfWeek === 6) {
      lastDay.setDate(lastDay.getDate() - 1); // é‡‘æ›œæ—¥
    } else if (dayOfWeek === 0) {
      lastDay.setDate(lastDay.getDate() - 2); // é‡‘æ›œæ—¥
    }
    
    return lastDay;
  }, []);

  const calculateNextPayday = useCallback((paydayDate, paydayType) => {
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    const currentDate = today.getDate();

    // æœˆæœ«æœ€çµ‚å¹³æ—¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
    if (paydayType === 'lastBusinessDay') {
      const thisMonthLastBusiness = getLastBusinessDayOfMonth(currentYear, currentMonth);
      
      if (currentDate < thisMonthLastBusiness.getDate() || 
          (currentDate === thisMonthLastBusiness.getDate() && today < thisMonthLastBusiness)) {
        return thisMonthLastBusiness;
      } else {
        return getLastBusinessDayOfMonth(currentYear, currentMonth + 1);
      }
    }

    // é€šå¸¸ã®æ—¥ä»˜æŒ‡å®šãƒ¢ãƒ¼ãƒ‰
    let nextPayday = new Date(currentYear, currentMonth, paydayDate);

    if (currentDate >= paydayDate) {
      nextPayday = new Date(currentYear, currentMonth + 1, paydayDate);
    }

    const monthLastDay = new Date(nextPayday.getFullYear(), nextPayday.getMonth() + 1, 0).getDate();
    if (paydayDate > monthLastDay) {
      nextPayday.setDate(monthLastDay);
    }

    return nextPayday;
  }, [getLastBusinessDayOfMonth]);

  const checkIfPayday = useCallback(() => {
    if (!data.settings?.paydayDate) return false;

    const today = new Date();
    const lastCheckDate = data.settings?.lastPaydayCheck 
      ? new Date(data.settings.lastPaydayCheck)
      : null;

    if (lastCheckDate && lastCheckDate.toDateString() === today.toDateString()) {
      return false;
    }

    const paydayType = data.settings?.paydayType || 'fixed';
    const paydayDate = Number(data.settings.paydayDate);
    const currentDate = today.getDate();

    // æœˆæœ«æœ€çµ‚å¹³æ—¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
    if (paydayType === 'lastBusinessDay') {
      const lastBusinessDay = getLastBusinessDayOfMonth(today.getFullYear(), today.getMonth());
      return currentDate === lastBusinessDay.getDate();
    }

    // é€šå¸¸ã®æ—¥ä»˜æŒ‡å®šãƒ¢ãƒ¼ãƒ‰
    if (currentDate === paydayDate) {
      return true;
    }

    const monthLastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    if (paydayDate > monthLastDay && currentDate === monthLastDay) {
      return true;
    }

    return false;
  }, [data.settings, getLastBusinessDayOfMonth]);

  const executeMonthlyReset = useCallback(async () => {
    let newSnapshots = data.monthlySnapshots || [];
    if (data.historySettings?.trackMonthlySnapshots) {
      const today = new Date();
      const snapshot = {
        id: Date.now().toString(),
        date: today.toISOString(),
        monthYear: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`,
        data: {
          monthlyIncome: data.monthlyIncome,
          accounts: JSON.parse(JSON.stringify(data.accounts)),
          fixedExpenses: JSON.parse(JSON.stringify(data.fixedExpenses)),
          savings: JSON.parse(JSON.stringify(data.savings)),
        },
      };
      newSnapshots = [...newSnapshots, snapshot];
    }

    // è²¯é‡‘ã®é€²æ—ã‚’æ›´æ–°
    const updatedSavings = data.savings.map(saving => ({
      ...saving,
      currentAmount: (Number(saving.currentAmount) || 0) + (Number(saving.monthlyAmount) || 0),
    }));

    // çµ¦ä¸å—å–ãƒã‚±ãƒ„ã‚’æ¢ã™
    let salaryBucketInfo = null;
    data.accounts?.forEach(account => {
      account.buckets?.forEach(bucket => {
        if (bucket.isSalaryBucket) {
          salaryBucketInfo = { accountId: account.id, bucketId: bucket.id };
        }
      });
    });

    // ãƒã‚±ãƒ„æ®‹é«˜ã‚’æ›´æ–°ï¼ˆå›ºå®šè²»ãƒ»è²¯é‡‘ã®æ”¯æ‰•å…ƒã‹ã‚‰æ¸›ç®— + è²¯é‡‘å…ˆã¸åŠ ç®—ï¼‰
    let updatedAccounts = JSON.parse(JSON.stringify(data.accounts));
    
    // 1. å›ºå®šè²»ã‚’å¼•ã
    data.fixedExpenses.forEach(expense => {
      if (expense.payFrom === 'income') {
        // æ‰‹å–ã‚Šã‹ã‚‰ â†’ çµ¦ä¸å—å–ãƒã‚±ãƒ„ã‹ã‚‰å¼•ã
        if (salaryBucketInfo) {
          updatedAccounts = updatedAccounts.map(account => {
            if (account.id === salaryBucketInfo.accountId) {
              return {
                ...account,
                buckets: account.buckets.map(bucket => {
                  if (bucket.id === salaryBucketInfo.bucketId) {
                    const newBalance = (Number(bucket.balance) || 0) - (Number(expense.amount) || 0);
                    return { ...bucket, balance: newBalance };
                  }
                  return bucket;
                }),
              };
            }
            return account;
          });
        }
      } else if (expense.payFrom && expense.payFrom.includes(':')) {
        // ãƒã‚±ãƒ„ã‹ã‚‰å¼•ã
        const [accountId, bucketId] = expense.payFrom.split(':');
        updatedAccounts = updatedAccounts.map(account => {
          if (account.id === accountId) {
            return {
              ...account,
              buckets: account.buckets.map(bucket => {
                if (bucket.id === bucketId) {
                  const newBalance = (Number(bucket.balance) || 0) - (Number(expense.amount) || 0);
                  return { ...bucket, balance: newBalance };
                }
                return bucket;
              }),
            };
          }
          return account;
        });
      }
    });

    // 2. è²¯é‡‘ã‚’å¼•ã
    data.savings.forEach(saving => {
      if (saving.payFrom === 'income') {
        // æ‰‹å–ã‚Šã‹ã‚‰ â†’ çµ¦ä¸å—å–ãƒã‚±ãƒ„ã‹ã‚‰å¼•ã
        if (salaryBucketInfo) {
          updatedAccounts = updatedAccounts.map(account => {
            if (account.id === salaryBucketInfo.accountId) {
              return {
                ...account,
                buckets: account.buckets.map(bucket => {
                  if (bucket.id === salaryBucketInfo.bucketId) {
                    const newBalance = (Number(bucket.balance) || 0) - (Number(saving.monthlyAmount) || 0);
                    return { ...bucket, balance: newBalance };
                  }
                  return bucket;
                }),
              };
            }
            return account;
          });
        }
      } else if (saving.payFrom && saving.payFrom.includes(':')) {
        // ãƒã‚±ãƒ„ã‹ã‚‰å¼•ã
        const [accountId, bucketId] = saving.payFrom.split(':');
        updatedAccounts = updatedAccounts.map(account => {
          if (account.id === accountId) {
            return {
              ...account,
              buckets: account.buckets.map(bucket => {
                if (bucket.id === bucketId) {
                  const newBalance = (Number(bucket.balance) || 0) - (Number(saving.monthlyAmount) || 0);
                  return { ...bucket, balance: newBalance };
                }
                return bucket;
              }),
            };
          }
          return account;
        });
      }
    });

    // 3. è²¯é‡‘å…ˆã®ãƒã‚±ãƒ„ã«åŠ ç®—
    data.savings.forEach(saving => {
      if (saving.saveTo && saving.saveTo.includes(':')) {
        const [accountId, bucketId] = saving.saveTo.split(':');
        updatedAccounts = updatedAccounts.map(account => {
          if (account.id === accountId) {
            return {
              ...account,
              buckets: account.buckets.map(bucket => {
                if (bucket.id === bucketId) {
                  const newBalance = (Number(bucket.balance) || 0) + (Number(saving.monthlyAmount) || 0);
                  return { ...bucket, balance: newBalance };
                }
                return bucket;
              }),
            };
          }
          return account;
        });
      }
    });

    const newData = {
      ...data,
      monthlyIncome: '',
      savings: updatedSavings,
      accounts: updatedAccounts,
      monthlySnapshots: newSnapshots,
      settings: {
        ...data.settings,
        lastPaydayCheck: new Date().toISOString(),
      },
    };

    setData(newData);
    setShouldShowResetModal(false);
  }, [data, setData]);

  useEffect(() => {
    if (data.settings?.paydayDate) {
      const next = calculateNextPayday(
        data.settings.paydayDate, 
        data.settings?.paydayType || 'fixed'
      );
      setNextPayday(next);
    }
  }, [data.settings?.paydayDate, data.settings?.paydayType, calculateNextPayday]);

  useEffect(() => {
    if (checkIfPayday()) {
      setShouldShowResetModal(true);
    }

    const interval = setInterval(() => {
      if (checkIfPayday()) {
        setShouldShowResetModal(true);
      }
    }, 60000);

    return () => clearInterval(interval);
  }, [checkIfPayday]);

  const updatePaydayDate = useCallback((newPaydayDate) => {
    const newData = {
      ...data,
      settings: {
        ...data.settings,
        paydayDate: newPaydayDate,
        paydayType: 'fixed', // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã¯å¸¸ã«fixed
      },
    };
    setData(newData);
  }, [data, setData]);

  const getDaysUntilNextPayday = useCallback(() => {
    if (!nextPayday) return 0;
    const today = new Date();
    const diffTime = nextPayday - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  }, [nextPayday]);

  return {
    shouldShowResetModal,
    nextPayday,
    executeMonthlyReset,
    updatePaydayDate,
    getDaysUntilNextPayday,
    closeResetModal: () => setShouldShowResetModal(false),
  };
};

// ========================================
// ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
// ========================================
function MoneyMapApp() {
  const [currentTab, setCurrentTab] = useState('home');
  const [data, setData] = useState({
    monthlyIncome: '',
    accounts: [],
    fixedExpenses: [],
    savings: [],
    monthlySnapshots: [],
    balanceHistory: [],
    historySettings: {
      trackBalanceHistory: false,
      trackMonthlySnapshots: false,
    },
    settings: {
      paydayDate: null,
      lastPaydayCheck: null,
      showDailyBudget: true,
    },
  });

  const [tempIncome, setTempIncome] = useState('');
  const [showQuickExpenseModal, setShowQuickExpenseModal] = useState(false);
  const [quickExpenseAmount, setQuickExpenseAmount] = useState('');
  const [selectedBucket, setSelectedBucket] = useState(null);

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  useEffect(() => {
    const loadData = async () => {
      try {
        const result = await window.storage.get('budgetData');
        if (result && result.value) {
          const loadedData = JSON.parse(result.value);
          setData(loadedData);
          setTempIncome(loadedData.monthlyIncome || '');
        }
      } catch (error) {
        // window.storageãŒå¤±æ•—ã—ãŸã‚‰localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
        try {
          const localData = localStorage.getItem('budgetData');
          if (localData) {
            const loadedData = JSON.parse(localData);
            setData(loadedData);
            setTempIncome(loadedData.monthlyIncome || '');
          }
        } catch (fallbackError) {
          // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—
        }
      }
    };
    loadData();
  }, []);

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
  const calculations = useBudgetCalculation(data);
  useAutoSave(data);
  const payday = usePaydayManagement(data, setData);

  // æ‰‹å–ã‚Šç¢ºå®š
  const confirmIncome = () => {
    const income = Number(tempIncome);
    if (isNaN(income) || income <= 0) return;
    
    // æ—¢ã«ç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (data.monthlyIncome) return;

    // çµ¦ä¸å—å–ãƒã‚±ãƒ„ã‚’æ¢ã™
    let salaryBucketFound = false;
    const updatedAccounts = data.accounts.map(account => {
      return {
        ...account,
        buckets: account.buckets.map(bucket => {
          if (bucket.isSalaryBucket) {
            salaryBucketFound = true;
            const newBalance = (Number(bucket.balance) || 0) + income;
            return { ...bucket, balance: newBalance };
          }
          return bucket;
        }),
      };
    });
    
    const newData = { 
      ...data, 
      monthlyIncome: tempIncome,
      accounts: updatedAccounts,
    };
    setData(newData);
  };

  // ã‚¯ã‚¤ãƒƒã‚¯æ”¯å‡ºç™»éŒ²
  const registerQuickExpense = () => {
    if (!quickExpenseAmount || !selectedBucket) return;

    const amount = Number(quickExpenseAmount);
    if (isNaN(amount) || amount <= 0) return;

    const newAccounts = data.accounts.map(account => {
      if (account.id === selectedBucket.accountId) {
        return {
          ...account,
          buckets: account.buckets.map(bucket => {
            if (bucket.id === selectedBucket.bucketId) {
              const newBalance = (Number(bucket.balance) || 0) - amount;
              // å±¥æ­´ã«è¨˜éŒ²ã‚’è¿½åŠ 
              const newHistory = [
                ...(bucket.history || []),
                {
                  id: Date.now().toString(),
                  date: new Date().toISOString(),
                  amount: amount,
                  memo: '', // ãƒ¡ãƒ¢ã¯ç©º
                },
              ];
              return { 
                ...bucket, 
                balance: newBalance,
                history: newHistory,
              };
            }
            return bucket;
          }),
        };
      }
      return account;
    });

    setData({ ...data, accounts: newAccounts });
    setQuickExpenseAmount('');
    setSelectedBucket(null);
    setShowQuickExpenseModal(false);
  };

  const getBucketList = () => {
    const buckets = [];
    data.accounts?.forEach(account => {
      account.buckets?.forEach(bucket => {
        buckets.push({
          accountId: account.id,
          accountName: account.name,
          bucketId: bucket.id,
          bucketName: bucket.name,
          balance: bucket.balance,
          displayName: `${account.name} - ${bucket.name}`,
        });
      });
    });
    return buckets;
  };

  return (
    <div className="min-h-screen bg-orange-50/30">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header className="header-sticky border-b border-orange-100/50 p-3">
        <h1 className="text-xl font-bold text-orange-500">
          Money Map
        </h1>
        <p className="text-xs text-orange-400/70 mt-0.5">ã‚ãªãŸã®ãŠé‡‘ã®åœ°å›³</p>
      </header>

      {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="main-content p-4">
        {currentTab === 'home' && (
          <HomeScreen
            data={data}
            setData={setData}
            tempIncome={tempIncome}
            setTempIncome={setTempIncome}
            confirmIncome={confirmIncome}
            calculations={calculations}
          />
        )}
        {currentTab === 'savings' && (
          <SavingsScreen
            data={data}
            setData={setData}
          />
        )}
        {currentTab === 'accounts' && <AccountsScreen data={data} setData={setData} />}
        {currentTab === 'history' && <HistoryScreen data={data} />}
        {currentTab === 'settings' && (
          <SettingsScreen
            data={data}
            setData={setData}
            payday={payday}
          />
        )}
      </div>

      {/* ã‚¯ã‚¤ãƒƒã‚¯æ”¯å‡ºãƒœã‚¿ãƒ³ */}
      <button
        onClick={() => setShowQuickExpenseModal(true)}
        className="quick-expense-btn bg-gradient-to-br from-rose-300 to-pink-300 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110"
      >
        <Zap className="w-6 h-6" />
      </button>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <nav className="bottom-nav">
        <div className="grid grid-cols-5">
          {[
            { id: 'home', icon: Home, label: 'ãƒ›ãƒ¼ãƒ ' },
            { id: 'savings', icon: PiggyBank, label: 'è²¯é‡‘' },
            { id: 'accounts', icon: Wallet, label: 'å£åº§' },
            { id: 'history', icon: History, label: 'å±¥æ­´' },
            { id: 'settings', icon: Settings, label: 'è¨­å®š' },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setCurrentTab(tab.id)}
              className={`flex flex-col items-center py-3 transition ${
                currentTab === tab.id ? 'text-sky-500' : 'text-gray-400'
              }`}
            >
              <tab.icon className="w-6 h-6" />
              <span className="text-xs mt-1">{tab.label}</span>
            </button>
          ))}
        </div>
      </nav>

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {payday.shouldShowResetModal && (
        <MonthlyResetModal
          data={data}
          onClose={payday.closeResetModal}
          onConfirm={payday.executeMonthlyReset}
        />
      )}

      {showQuickExpenseModal && (
        <QuickExpenseModal
          amount={quickExpenseAmount}
          setAmount={setQuickExpenseAmount}
          selectedBucket={selectedBucket}
          setSelectedBucket={setSelectedBucket}
          bucketList={getBucketList()}
          onClose={() => setShowQuickExpenseModal(false)}
          onSubmit={registerQuickExpense}
        />
      )}
    </div>
  );
}

// ========================================
// ãƒ›ãƒ¼ãƒ ç”»é¢
// ========================================
function HomeScreen({ data, setData, tempIncome, setTempIncome, confirmIncome, calculations }) {
  const [editingFixedExpense, setEditingFixedExpense] = useState(null);
  const [editingSaving, setEditingSaving] = useState(null);

  // æ”¯æ‰•å…ƒã®è¡¨ç¤ºåã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const getPayFromLabel = (payFrom) => {
    if (payFrom === 'income') return 'æ‰‹å–ã‚Šã‹ã‚‰';
    
    if (payFrom.includes(':')) {
      const [accountId, bucketId] = payFrom.split(':');
      const account = data.accounts?.find(a => a.id === accountId);
      if (account) {
        const bucket = account.buckets?.find(b => b.id === bucketId);
        if (bucket) {
          return `${account.name} - ${bucket.name}`;
        }
      }
    }
    
    return 'ãƒã‚±ãƒ„ã‹ã‚‰';
  };

  // ç©ç«‹å…ˆã®è¡¨ç¤ºåã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const getSaveToLabel = (saveTo) => {
    if (!saveTo) return 'æœªè¨­å®š';
    
    if (saveTo.includes(':')) {
      const [accountId, bucketId] = saveTo.split(':');
      const account = data.accounts?.find(a => a.id === accountId);
      if (account) {
        const bucket = account.buckets?.find(b => b.id === bucketId);
        if (bucket) {
          return `${account.name} - ${bucket.name}`;
        }
      }
    }
    
    return 'æœªè¨­å®š';
  };

  return (
    <div className="space-y-4">
      {/* æ‰‹å–ã‚Šçµ¦æ–™å…¥åŠ› */}
      <section className="bg-white/90 rounded-xl shadow-sm p-5 border border-orange-100/50">
        <h2 className="text-sm font-semibold text-orange-500 mb-3">ä»Šæœˆã®æ‰‹å–ã‚Šçµ¦æ–™</h2>
        
        {data.monthlyIncome ? (
          // ç¢ºå®šæ¸ˆã¿ã®å ´åˆ
          <div className="space-y-3">
            <div className="flex items-center justify-between p-4 bg-emerald-50 rounded-lg border border-emerald-100">
              <div>
                <p className="text-sm text-emerald-600 font-medium">ç¢ºå®šæ¸ˆã¿</p>
                <p className="text-2xl font-bold text-emerald-700 mt-1">
                  Â¥{Number(data.monthlyIncome).toLocaleString()}
                </p>
              </div>
              <div className="text-emerald-600">
                <svg className="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            <button
              onClick={() => {
                // ç¢ºå®šã‚’ã‚¯ãƒªã‚¢ã—ã¦ä¿®æ­£å¯èƒ½ã«ã™ã‚‹
                // çµ¦ä¸å—å–ãƒã‚±ãƒ„ã‚’æ¢ã—ã¦çµ¦æ–™ã‚’å¼•ãæˆ»ã™
                const updatedAccounts = data.accounts.map(account => {
                  return {
                    ...account,
                    buckets: account.buckets.map(bucket => {
                      if (bucket.isSalaryBucket) {
                        const newBalance = (Number(bucket.balance) || 0) - (Number(data.monthlyIncome) || 0);
                        return { ...bucket, balance: newBalance };
                      }
                      return bucket;
                    }),
                  };
                });
                setData({ ...data, monthlyIncome: '', accounts: updatedAccounts });
                setTempIncome(data.monthlyIncome);
              }}
              className="w-full px-4 py-2 text-sm border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50"
            >
              ä¿®æ­£ã™ã‚‹
            </button>
          </div>
        ) : (
          // æœªç¢ºå®šã®å ´åˆï¼ˆå…¥åŠ›å¯èƒ½ï¼‰
          <>
            <div className="flex gap-2 items-center mb-3">
              <input
                type="number"
                value={tempIncome}
                onChange={(e) => setTempIncome(e.target.value)}
                placeholder="250000"
                className="flex-1 px-4 py-3 text-lg border border-orange-100 rounded-lg focus:ring-2 focus:ring-sky-300 focus:border-transparent"
              />
              <span className="text-gray-500 font-medium">å††</span>
            </div>
            <button
              onClick={confirmIncome}
              className="w-full px-5 py-2.5 bg-sky-300 text-white rounded-lg hover:bg-sky-400 transition font-semibold shadow-sm"
            >
              ğŸ’° ç¢ºå®šã™ã‚‹
            </button>
          </>
        )}
      </section>

      {/* ä»Šæœˆã‚ã¨ä½¿ãˆã‚‹ãŠé‡‘ */}
      <section className="bg-gradient-to-br from-sky-50 via-blue-50/50 to-indigo-50 rounded-2xl shadow-sm p-6 border border-sky-100">
        <h2 className="text-sm text-sky-600 mb-2">ä»Šæœˆã‚ã¨ä½¿ãˆã‚‹ãŠé‡‘</h2>
        <p className="text-5xl font-bold text-sky-500 mb-3">
          Â¥{calculations.remainingMoney.toLocaleString()}
        </p>
        {data.settings?.showDailyBudget && calculations.remainingDays > 0 && (
          <div className="bg-white/80 rounded-lg p-3 text-sm text-sky-600 border border-sky-100/50">
            ğŸ“… æ®‹ã‚Š{calculations.remainingDays}æ—¥ (1æ—¥ã‚ãŸã‚Šç´„Â¥{calculations.dailyBudget.toLocaleString()})
          </div>
        )}
      </section>

      {/* å£åº§æ®‹é«˜ã¨æ‰‹å–ã‚Šã‹ã‚‰å¼•ãåˆ† */}
      <section className="grid grid-cols-2 gap-4">
        <div className="bg-gradient-to-br from-emerald-50/70 to-teal-50/70 rounded-xl shadow-sm p-4 border border-emerald-100/50">
          <h3 className="text-xs text-emerald-600 mb-2">å£åº§æ®‹é«˜åˆè¨ˆ</h3>
          <p className="text-2xl font-bold text-emerald-500">
            Â¥{calculations.totalBalance.toLocaleString()}
          </p>
        </div>
        <div className="bg-gradient-to-br from-rose-50/70 to-pink-50/70 rounded-xl shadow-sm p-4 border border-rose-100/50">
          <h3 className="text-xs text-rose-600 mb-2">æ‰‹å–ã‚Šã‹ã‚‰å¼•ãåˆ†</h3>
          <p className="text-2xl font-bold text-rose-500">
            Â¥{calculations.deductFromIncome.toLocaleString()}
          </p>
        </div>
      </section>

      {/* å›ºå®šè²»ä¸€è¦§ */}
      <section className="bg-white/80 rounded-xl shadow-sm p-5 border border-purple-100/50">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-semibold text-purple-500">å›ºå®šè²»</h2>
          <button
            onClick={() => setEditingFixedExpense({})}
            className="text-purple-400 hover:text-purple-500 text-sm font-medium"
          >
            + è¿½åŠ 
          </button>
        </div>
        {data.fixedExpenses.length === 0 ? (
          <p className="text-gray-400 text-sm text-center py-4">å›ºå®šè²»ãŒã‚ã‚Šã¾ã›ã‚“</p>
        ) : (
          <div className="space-y-2">
            {data.fixedExpenses.map(expense => {
              // æ®‹ã‚ŠæœŸé–“ã‚’è¨ˆç®—
              let remainingMonths = null;
              if (expense.endDate) {
                const today = new Date();
                const end = new Date(expense.endDate);
                const diffTime = end - today;
                remainingMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));
              }

              return (
                <div key={expense.id} className="flex justify-between items-center p-3 bg-purple-50/50 rounded-lg border border-purple-100/50">
                  <div className="flex-1">
                    <p className="font-medium text-gray-700">{expense.name}</p>
                    <p className="text-xs text-gray-500">
                      {getPayFromLabel(expense.payFrom)}
                    </p>
                    {expense.endDate && remainingMonths !== null && (
                      <p className="text-xs text-purple-500 mt-1">
                        {remainingMonths > 0 
                          ? `ğŸ• ã‚ã¨${remainingMonths}ãƒ¶æœˆ`
                          : 'âœ“ æ”¯æ‰•ã„å®Œäº†äºˆå®š'}
                      </p>
                    )}
                  </div>
                  <div className="flex items-center gap-3">
                    <p className="font-semibold text-purple-500">
                      Â¥{Number(expense.amount).toLocaleString()}
                    </p>
                    <button
                      onClick={() => setEditingFixedExpense(expense)}
                      className="text-gray-400 hover:text-gray-500"
                    >
                      <Edit2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* è²¯é‡‘ãƒ»ç©ç«‹ä¸€è¦§ï¼ˆé€²è¡Œä¸­ã®ã¿ï¼‰ */}
      <section className="bg-white/90 rounded-xl shadow-sm p-5 border border-gray-100">
        <div className="flex justify-between items-center mb-4">
          <div>
            <h2 className="text-lg font-semibold text-amber-500">è²¯é‡‘ãƒ»ç©ç«‹ï¼ˆé€²è¡Œä¸­ï¼‰</h2>
            {data.savings.filter(s => {
              const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
              return progress >= 100;
            }).length > 0 && (
              <p className="text-xs text-emerald-600 mt-1">
                âœ¨ é”æˆæ¸ˆã¿: {data.savings.filter(s => {
                  const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
                  return progress >= 100;
                }).length}ä»¶
              </p>
            )}
          </div>
          <button
            onClick={() => setEditingSaving({})}
            className="text-sky-500 hover:text-sky-600 text-sm font-medium"
          >
            + è¿½åŠ 
          </button>
        </div>
        {data.savings.filter(s => {
          const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
          return progress < 100;
        }).length === 0 ? (
          <p className="text-gray-400 text-sm text-center py-4">é€²è¡Œä¸­ã®è²¯é‡‘ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“</p>
        ) : (
          <div className="space-y-5">
            {Object.keys(SAVING_CATEGORIES).map(categoryKey => {
              const category = SAVING_CATEGORIES[categoryKey];
              const categorySavings = data.savings.filter(s => {
                const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
                return s.category === categoryKey && progress < 100;
              });
              
              if (categorySavings.length === 0) return null;
              
              const CategoryIcon = category.icon;
              
              return (
                <div key={categoryKey} className="space-y-3">
                  <div className="flex items-center gap-2">
                    <CategoryIcon className={`w-4 h-4 ${category.textColor}`} />
                    <h3 className={`text-sm font-semibold ${category.textColor}`}>
                      {category.name}
                    </h3>
                  </div>
                  <div className="space-y-3">
                    {categorySavings.map(saving => {
                      const progress = (Number(saving.currentAmount) / Number(saving.targetAmount)) * 100;
                      return (
                        <div key={saving.id} className={`p-4 ${category.bgColor} rounded-lg border ${category.borderColor}`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="font-medium text-gray-700">{saving.name}</p>
                              <p className="text-xs text-gray-500">
                                {getPayFromLabel(saving.payFrom)} â†’ {getSaveToLabel(saving.saveTo)}
                              </p>
                              <p className="text-xs text-gray-500 mt-0.5">
                                æœˆÂ¥{Number(saving.monthlyAmount).toLocaleString()}
                              </p>
                            </div>
                            <button
                              onClick={() => setEditingSaving(saving)}
                              className="text-gray-400 hover:text-gray-500"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                          </div>
                          <div className="mb-2">
                            <div className={`h-2 ${category.bgColor} rounded-full overflow-hidden border ${category.borderColor}`}>
                              <div
                                className={`h-full bg-gradient-to-r ${category.progressColor}`}
                                style={{ width: `${Math.min(progress, 100)}%` }}
                              />
                            </div>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">
                              Â¥{Number(saving.currentAmount).toLocaleString()} / 
                              Â¥{Number(saving.targetAmount).toLocaleString()}
                            </span>
                            <span className={`font-semibold ${category.textColor}`}>
                              {progress.toFixed(0)}%
                            </span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {editingFixedExpense && (
        <FixedExpenseModal
          expense={editingFixedExpense}
          data={data}
          setData={setData}
          onClose={() => setEditingFixedExpense(null)}
        />
      )}

      {editingSaving && (
        <SavingModal
          saving={editingSaving}
          data={data}
          setData={setData}
          onClose={() => setEditingSaving(null)}
        />
      )}
    </div>
  );
}

// ========================================
// å£åº§ç”»é¢
// ========================================
// ========================================
// è²¯é‡‘ç”»é¢
// ========================================
function SavingsScreen({ data, setData }) {
  const [activeTab, setActiveTab] = useState('inProgress');
  const [editingSaving, setEditingSaving] = useState(null);
  const [confirmUseSaving, setConfirmUseSaving] = useState(null);
  const [confirmUndoSaving, setConfirmUndoSaving] = useState(null);

  // æ”¯æ‰•å…ƒã®è¡¨ç¤ºåã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const getPayFromLabel = (payFrom) => {
    if (payFrom === 'income') return 'æ‰‹å–ã‚Šã‹ã‚‰';
    
    if (payFrom.includes(':')) {
      const [accountId, bucketId] = payFrom.split(':');
      const account = data.accounts?.find(a => a.id === accountId);
      if (account) {
        const bucket = account.buckets?.find(b => b.id === bucketId);
        if (bucket) {
          return `${account.name} - ${bucket.name}`;
        }
      }
    }
    
    return 'ãƒã‚±ãƒ„ã‹ã‚‰';
  };

  // ç©ç«‹å…ˆã®è¡¨ç¤ºåã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const getSaveToLabel = (saveTo) => {
    if (!saveTo) return 'æœªè¨­å®š';
    
    if (saveTo.includes(':')) {
      const [accountId, bucketId] = saveTo.split(':');
      const account = data.accounts?.find(a => a.id === accountId);
      if (account) {
        const bucket = account.buckets?.find(b => b.id === bucketId);
        if (bucket) {
          return `${account.name} - ${bucket.name}`;
        }
      }
    }
    
    return 'æœªè¨­å®š';
  };

  // è²¯é‡‘ã‚’ä½¿ã£ãŸå‡¦ç†
  const markAsUsed = (saving) => {
    if (!saving.saveTo || !saving.saveTo.includes(':')) {
      alert('ç©ç«‹å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä½¿ç”¨å‡¦ç†ãŒã§ãã¾ã›ã‚“');
      return;
    }

    const [accountId, bucketId] = saving.saveTo.split(':');
    
    // ãƒã‚±ãƒ„ã‹ã‚‰é‡‘é¡ã‚’å¼•ã
    const updatedAccounts = data.accounts.map(account => {
      if (account.id === accountId) {
        return {
          ...account,
          buckets: account.buckets.map(bucket => {
            if (bucket.id === bucketId) {
              const newBalance = (Number(bucket.balance) || 0) - (Number(saving.currentAmount) || 0);
              return { ...bucket, balance: Math.max(0, newBalance) };
            }
            return bucket;
          }),
        };
      }
      return account;
    });

    // è²¯é‡‘ã«ä½¿ç”¨æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    const updatedSavings = data.savings.map(s =>
      s.id === saving.id ? { ...s, used: true, usedDate: new Date().toISOString() } : s
    );

    setData({
      ...data,
      accounts: updatedAccounts,
      savings: updatedSavings,
    });

    setConfirmUseSaving(null);
  };

  // ä½¿ç”¨ã‚’å–ã‚Šæ¶ˆã™å‡¦ç†
  const undoUsed = (saving) => {
    if (!saving.saveTo || !saving.saveTo.includes(':')) {
      alert('ç©ç«‹å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å–ã‚Šæ¶ˆã—å‡¦ç†ãŒã§ãã¾ã›ã‚“');
      return;
    }

    const [accountId, bucketId] = saving.saveTo.split(':');
    
    // ãƒã‚±ãƒ„ã«é‡‘é¡ã‚’æˆ»ã™
    const updatedAccounts = data.accounts.map(account => {
      if (account.id === accountId) {
        return {
          ...account,
          buckets: account.buckets.map(bucket => {
            if (bucket.id === bucketId) {
              const newBalance = (Number(bucket.balance) || 0) + (Number(saving.currentAmount) || 0);
              return { ...bucket, balance: newBalance };
            }
            return bucket;
          }),
        };
      }
      return account;
    });

    // ä½¿ç”¨æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
    const updatedSavings = data.savings.map(s =>
      s.id === saving.id ? { ...s, used: false, usedDate: null } : s
    );

    setData({
      ...data,
      accounts: updatedAccounts,
      savings: updatedSavings,
    });

    setConfirmUndoSaving(null);
  };

  // é€²è¡Œä¸­ã¨é”æˆæ¸ˆã¿ã«åˆ†é¡
  const inProgressSavings = data.savings.filter(s => {
    const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
    return progress < 100;
  });

  const completedSavings = data.savings.filter(s => {
    const progress = (Number(s.currentAmount) / Number(s.targetAmount)) * 100;
    return progress >= 100;
  });

  const renderSavingsList = (savingsList) => {
    if (savingsList.length === 0) {
      return (
        <p className="text-gray-400 text-sm text-center py-8">
          {activeTab === 'inProgress' ? 'é€²è¡Œä¸­ã®è²¯é‡‘ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“' : 'é”æˆã—ãŸè²¯é‡‘ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“'}
        </p>
      );
    }

    return (
      <div className="space-y-5">
        {Object.keys(SAVING_CATEGORIES).map(categoryKey => {
          const category = SAVING_CATEGORIES[categoryKey];
          const categorySavings = savingsList.filter(s => s.category === categoryKey);
          
          if (categorySavings.length === 0) return null;
          
          const CategoryIcon = category.icon;
          
          return (
            <div key={categoryKey} className="space-y-3">
              <div className="flex items-center gap-2">
                <CategoryIcon className={`w-4 h-4 ${category.textColor}`} />
                <h3 className={`text-sm font-semibold ${category.textColor}`}>
                  {category.name}
                </h3>
              </div>
              <div className="space-y-3">
                {categorySavings.map(saving => {
                  const progress = (Number(saving.currentAmount) / Number(saving.targetAmount)) * 100;
                  const isCompleted = progress >= 100;
                  
                  return (
                    <div key={saving.id} className={`p-4 ${category.bgColor} rounded-lg border ${category.borderColor} ${saving.used ? 'opacity-60' : ''}`}>
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 flex-wrap">
                            <p className="font-medium text-gray-700">{saving.name}</p>
                            {isCompleted && !saving.used && (
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-xs rounded-full font-semibold">
                                é”æˆï¼
                              </span>
                            )}
                            {saving.used && (
                              <span className="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full font-semibold">
                                ä½¿ç”¨æ¸ˆã¿
                              </span>
                            )}
                          </div>
                          <p className="text-xs text-gray-500">
                            {getPayFromLabel(saving.payFrom)} â†’ {getSaveToLabel(saving.saveTo)}
                          </p>
                          <p className="text-xs text-gray-500 mt-0.5">
                            æœˆÂ¥{Number(saving.monthlyAmount).toLocaleString()}
                          </p>
                          {saving.used && saving.usedDate && (
                            <p className="text-xs text-gray-400 mt-1">
                              ä½¿ç”¨æ—¥: {new Date(saving.usedDate).toLocaleDateString('ja-JP')}
                            </p>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          {isCompleted && !saving.used && (
                            <button
                              onClick={() => setConfirmUseSaving(saving)}
                              className="px-3 py-1.5 bg-sky-400 text-white text-xs rounded-lg hover:bg-sky-500 transition font-semibold"
                            >
                              ä½¿ã£ãŸ
                            </button>
                          )}
                          {saving.used && (
                            <button
                              onClick={() => setConfirmUndoSaving(saving)}
                              className="px-3 py-1.5 bg-amber-400 text-white text-xs rounded-lg hover:bg-amber-500 transition font-semibold"
                            >
                              å–ã‚Šæ¶ˆã—
                            </button>
                          )}
                          <button
                            onClick={() => setEditingSaving(saving)}
                            className="text-gray-400 hover:text-gray-500"
                          >
                            <Edit2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                      <div className="mb-2">
                        <div className={`h-2 ${category.bgColor} rounded-full overflow-hidden border ${category.borderColor}`}>
                          <div
                            className={`h-full bg-gradient-to-r ${category.progressColor}`}
                            style={{ width: `${Math.min(progress, 100)}%` }}
                          />
                        </div>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600">
                          Â¥{Number(saving.currentAmount).toLocaleString()} / 
                          Â¥{Number(saving.targetAmount).toLocaleString()}
                        </span>
                        <span className={`font-semibold ${category.textColor}`}>
                          {progress.toFixed(0)}%
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    );
  };

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-700">è²¯é‡‘ãƒ»ç©ç«‹</h1>
        <button
          onClick={() => setEditingSaving({})}
          className="px-4 py-2 bg-sky-300 text-white rounded-lg hover:bg-sky-400 transition font-medium"
        >
          + è¿½åŠ 
        </button>
      </div>

      {/* ã‚¿ãƒ– */}
      <div className="bg-white rounded-xl shadow-sm p-1 flex gap-1 border border-gray-100">
        <button
          onClick={() => setActiveTab('inProgress')}
          className={`flex-1 py-2 rounded-lg font-medium transition ${
            activeTab === 'inProgress'
              ? 'bg-sky-300 text-white'
              : 'text-gray-500 hover:bg-sky-50'
          }`}
        >
          é€²è¡Œä¸­ ({inProgressSavings.length})
        </button>
        <button
          onClick={() => setActiveTab('completed')}
          className={`flex-1 py-2 rounded-lg font-medium transition ${
            activeTab === 'completed'
              ? 'bg-emerald-300 text-white'
              : 'text-gray-500 hover:bg-emerald-50'
          }`}
        >
          é”æˆæ¸ˆã¿ ({completedSavings.length})
        </button>
      </div>

      {/* è²¯é‡‘ä¸€è¦§ */}
      <section className="bg-white/90 rounded-xl shadow-sm p-5 border border-gray-100">
        {activeTab === 'inProgress' ? renderSavingsList(inProgressSavings) : renderSavingsList(completedSavings)}
      </section>

      {/* ä½¿ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {confirmUseSaving && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div className="p-6">
              <h2 className="text-xl font-bold text-gray-700 mb-4">è²¯é‡‘ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h2>
              <p className="text-gray-600 mb-2">
                <span className="font-semibold">{confirmUseSaving.name}</span> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
              </p>
              <p className="text-gray-600 mb-4">
                ç©ç«‹å…ˆã®ãƒã‚±ãƒ„ã‹ã‚‰ <span className="font-semibold text-sky-600">Â¥{Number(confirmUseSaving.currentAmount).toLocaleString()}</span> ãŒå¼•ã‹ã‚Œã¾ã™ã€‚
              </p>
              <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                <p className="text-sm text-blue-700">
                  ğŸ’¡ å¾Œã§å–ã‚Šæ¶ˆã™ã“ã¨ã‚‚ã§ãã¾ã™
                </p>
              </div>
            </div>
            <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
              <button
                onClick={() => setConfirmUseSaving(null)}
                className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={() => markAsUsed(confirmUseSaving)}
                className="flex-1 px-4 py-2 bg-sky-400 text-white rounded-lg hover:bg-sky-500 font-semibold"
              >
                ä½¿ç”¨ã™ã‚‹
              </button>
            </div>
          </div>
        </div>
      )}

      {/* å–ã‚Šæ¶ˆã—ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {confirmUndoSaving && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div className="p-6">
              <h2 className="text-xl font-bold text-gray-700 mb-4">ä½¿ç”¨ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</h2>
              <p className="text-gray-600 mb-2">
                <span className="font-semibold">{confirmUndoSaving.name}</span> ã®ä½¿ç”¨ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã€‚
              </p>
              <p className="text-gray-600 mb-4">
                ç©ç«‹å…ˆã®ãƒã‚±ãƒ„ã« <span className="font-semibold text-amber-600">Â¥{Number(confirmUndoSaving.currentAmount).toLocaleString()}</span> ãŒæˆ»ã•ã‚Œã¾ã™ã€‚
              </p>
            </div>
            <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
              <button
                onClick={() => setConfirmUndoSaving(null)}
                className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={() => undoUsed(confirmUndoSaving)}
                className="flex-1 px-4 py-2 bg-amber-400 text-white rounded-lg hover:bg-amber-500 font-semibold"
              >
                å–ã‚Šæ¶ˆã™
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {editingSaving && (
        <SavingModal
          saving={editingSaving}
          data={data}
          setData={setData}
          onClose={() => setEditingSaving(null)}
        />
      )}
    </div>
  );
}

// ========================================
// å£åº§ç®¡ç†ç”»é¢
// ========================================
function AccountsScreen({ data, setData }) {
  const [editingAccount, setEditingAccount] = useState(null);
  const [editingBucket, setEditingBucket] = useState(null);
  const [selectedAccountId, setSelectedAccountId] = useState(null);

  const addAccount = () => {
    setEditingAccount({ id: null, name: '', buckets: [] });
  };

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-600">å£åº§ç®¡ç†</h1>
        <button
          onClick={addAccount}
          className="px-4 py-2 bg-sky-300 text-white rounded-lg hover:bg-sky-400 transition font-medium"
        >
          + å£åº§è¿½åŠ 
        </button>
      </div>

      {data.accounts.length === 0 ? (
        <div className="bg-white rounded-xl shadow-sm p-8 text-center border border-gray-200">
          <Wallet className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-400">å£åº§ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button
            onClick={addAccount}
            className="mt-4 text-slate-500 hover:text-slate-600 font-medium"
          >
            æœ€åˆã®å£åº§ã‚’ä½œæˆ
          </button>
        </div>
      ) : (
        data.accounts.map(account => (
          <div key={account.id} className="bg-white rounded-2xl shadow-sm overflow-hidden border border-indigo-100/50">
            <div className="p-5 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-indigo-100/50">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <h2 className="text-xl font-bold text-indigo-600">{account.name}</h2>
                </div>
                <button
                  onClick={() => setEditingAccount(account)}
                  className="text-indigo-500 hover:text-indigo-600"
                >
                  <Edit2 className="w-5 h-5" />
                </button>
              </div>
              <p className="text-sm text-indigo-500 mt-1">
                åˆè¨ˆ: Â¥
                {account.buckets
                  .reduce((sum, b) => sum + (Number(b.balance) || 0), 0)
                  .toLocaleString()}
              </p>
            </div>
            <div className="p-5">
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-sm font-semibold text-gray-500">ãƒã‚±ãƒ„ä¸€è¦§</h3>
                <button
                  onClick={() => {
                    setSelectedAccountId(account.id);
                    setEditingBucket({ id: null, name: '', balance: '' });
                  }}
                  className="text-indigo-500 hover:text-indigo-600 text-sm font-medium"
                >
                  + ãƒã‚±ãƒ„è¿½åŠ 
                </button>
              </div>
              {account.buckets.length === 0 ? (
                <p className="text-gray-400 text-sm text-center py-4">ãƒã‚±ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p>
              ) : (
                <div className="space-y-2">
                  {account.buckets.map(bucket => {
                    const hasGoal = bucket.goalAmount;
                    const progress = hasGoal ? ((Number(bucket.balance) || 0) / Number(bucket.goalAmount)) * 100 : 0;
                    const isAchieved = progress >= 100;
                    
                    return (
                      <div
                        key={bucket.id}
                        className="p-3 bg-gray-50 rounded-lg border border-gray-100"
                      >
                        <div className="flex justify-between items-center mb-2">
                          <div className="flex items-center gap-2">
                            <p className="font-medium text-gray-600">{bucket.name}</p>
                            {bucket.isSalaryBucket && (
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-xs rounded-full font-semibold">
                                ğŸ’° çµ¦ä¸
                              </span>
                            )}
                          </div>
                          <div className="flex items-center gap-3">
                            <p className="font-semibold text-gray-600">
                              Â¥{Number(bucket.balance).toLocaleString()}
                            </p>
                            <button
                              onClick={() => {
                                setSelectedAccountId(account.id);
                                setEditingBucket(bucket);
                              }}
                              className="text-gray-400 hover:text-gray-500"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                        
                        {/* ç›®æ¨™è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ */}
                        {hasGoal && (
                          <div className="mt-2 space-y-1">
                            <div className="flex justify-between items-center">
                              <span className="text-xs text-gray-500">
                                ç›®æ¨™: Â¥{Number(bucket.goalAmount).toLocaleString()}
                              </span>
                              <span className={`text-xs font-bold ${isAchieved ? 'text-green-600' : 'text-sky-600'}`}>
                                {progress.toFixed(0)}%
                              </span>
                            </div>
                            <div className="w-full bg-white rounded-full h-1.5">
                              <div
                                className={`h-1.5 rounded-full transition-all ${
                                  isAchieved 
                                    ? 'bg-gradient-to-r from-green-400 to-emerald-400' 
                                    : 'bg-gradient-to-r from-sky-400 to-blue-400'
                                }`}
                                style={{ width: `${Math.min(progress, 100)}%` }}
                              />
                            </div>
                            {bucket.goalDeadline && (
                              <div className="text-xs text-gray-500">
                                æœŸé™: {bucket.goalDeadline.replace('-', 'å¹´')}æœˆ
                              </div>
                            )}
                            {isAchieved && (
                              <div className="text-xs text-green-600 font-medium">
                                ğŸ‰ ç›®æ¨™é”æˆï¼
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        ))
      )}

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {editingAccount && (
        <AccountModal
          account={editingAccount}
          data={data}
          setData={setData}
          onClose={() => setEditingAccount(null)}
        />
      )}

      {editingBucket && (
        <BucketModal
          bucket={editingBucket}
          accountId={selectedAccountId}
          data={data}
          setData={setData}
          onClose={() => {
            setEditingBucket(null);
            setSelectedAccountId(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// å±¥æ­´ç”»é¢
// ========================================
function HistoryScreen({ data }) {
  const [activeTab, setActiveTab] = useState('snapshots');
  
  // æ”¯å‡ºåˆ†æç”¨ã®æœˆé¸æŠstate
  const now = new Date();
  const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const [selectedExpenseMonth, setSelectedExpenseMonth] = useState(defaultMonth);

  return (
    <div className="space-y-4">
      <h1 className="text-2xl font-bold text-gray-600">å±¥æ­´</h1>

      {/* ã‚¿ãƒ– */}
      <div className="bg-white rounded-xl shadow-sm p-1 flex gap-1 border border-teal-100/50">
        <button
          onClick={() => setActiveTab('snapshots')}
          className={`flex-1 py-2 rounded-lg font-medium transition ${
            activeTab === 'snapshots'
              ? 'bg-teal-300 text-white'
              : 'text-gray-500 hover:bg-teal-50'
          }`}
        >
          æœˆæ¬¡è¨˜éŒ²
        </button>
        <button
          onClick={() => setActiveTab('expenses')}
          className={`flex-1 py-2 rounded-lg font-medium transition ${
            activeTab === 'expenses'
              ? 'bg-teal-300 text-white'
              : 'text-gray-500 hover:bg-teal-50'
          }`}
        >
          æ”¯å‡ºåˆ†æ
        </button>
      </div>

      {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      {activeTab === 'snapshots' && (
        <div className="space-y-3">
          {!data.monthlySnapshots || data.monthlySnapshots.length === 0 ? (
            <div className="bg-white rounded-xl shadow-sm p-8 text-center border border-gray-200">
              <History className="w-16 h-16 text-gray-300 mx-auto mb-4" />
              <p className="text-gray-400">æœˆæ¬¡è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
              <p className="text-sm text-gray-400 mt-2">
                è¨­å®šã§ã€Œæœˆæ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€çµ¦æ–™æ—¥ã«è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™
              </p>
            </div>
          ) : (
            data.monthlySnapshots.map(snapshot => {
              const date = new Date(snapshot.date);
              return (
                <div key={snapshot.id} className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="font-semibold text-gray-600">{snapshot.monthYear}</h3>
                      <p className="text-xs text-gray-400">
                        {date.toLocaleDateString('ja-JP')}
                      </p>
                    </div>
                    <p className="text-lg font-bold text-gray-600">
                      Â¥{Number(snapshot.data.monthlyIncome).toLocaleString()}
                    </p>
                  </div>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div className="bg-gray-50 rounded-lg p-3 border border-gray-100">
                      <p className="text-xs text-gray-400 mb-1">å£åº§æ®‹é«˜</p>
                      <p className="font-semibold text-gray-600">
                        Â¥{snapshot.data.totalBalance?.toLocaleString() || '0'}
                      </p>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-3 border border-gray-100">
                      <p className="text-xs text-gray-400 mb-1">å›ºå®šè²»</p>
                      <p className="font-semibold text-gray-600">
                        Â¥
                        {snapshot.data.fixedExpenses
                          ?.reduce((sum, e) => sum + (Number(e.amount) || 0), 0)
                          .toLocaleString() || '0'}
                      </p>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {activeTab === 'expenses' && (
        <div className="space-y-4">
          {(() => {
            // åˆ©ç”¨å¯èƒ½ãªæœˆã‚’å–å¾—
            const availableMonths = new Set();
            data.accounts?.forEach(account => {
              account.buckets?.forEach(bucket => {
                bucket.history?.forEach(h => {
                  const date = new Date(h.date);
                  const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                  availableMonths.add(monthKey);
                });
              });
            });
            
            const monthsList = Array.from(availableMonths).sort().reverse();
            
            // é¸æŠã•ã‚ŒãŸæœˆã®å¹´ã¨æœˆã‚’å–å¾—
            const [selectedYear, selectedMonthNum] = selectedExpenseMonth.split('-').map(Number);
            const targetMonth = selectedMonthNum - 1; // 0-based
            
            // é¸æŠã•ã‚ŒãŸæœˆã®æ”¯å‡ºã‚’é›†è¨ˆ
            const bucketExpenses = [];
            let totalExpenses = 0;
            
            data.accounts?.forEach(account => {
              account.buckets?.forEach(bucket => {
                const monthlyExpenses = bucket.history?.filter(h => {
                  const expenseDate = new Date(h.date);
                  return expenseDate.getMonth() === targetMonth && 
                         expenseDate.getFullYear() === selectedYear;
                }) || [];
                
                const total = monthlyExpenses.reduce((sum, h) => sum + Number(h.amount), 0);
                totalExpenses += total;
                
                if (monthlyExpenses.length > 0) {
                  bucketExpenses.push({
                    accountName: account.name,
                    bucketName: bucket.name,
                    total: total,
                    count: monthlyExpenses.length,
                    history: monthlyExpenses,
                  });
                }
              });
            });
            
            // é‡‘é¡é †ã«ã‚½ãƒ¼ãƒˆ
            bucketExpenses.sort((a, b) => b.total - a.total);
            
            return (
              <>
                {/* æœˆé¸æŠ */}
                {monthsList.length > 0 && (
                  <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
                    <label className="block text-sm font-medium text-gray-600 mb-2">è¡¨ç¤ºæœŸé–“</label>
                    <select
                      value={selectedExpenseMonth}
                      onChange={(e) => setSelectedExpenseMonth(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400"
                    >
                      {monthsList.map(month => {
                        const [year, monthNum] = month.split('-');
                        return (
                          <option key={month} value={month}>
                            {year}å¹´{monthNum}æœˆ
                          </option>
                        );
                      })}
                    </select>
                  </div>
                )}
                
                {bucketExpenses.length === 0 ? (
                  <div className="bg-white rounded-xl shadow-sm p-8 text-center border border-gray-200">
                    <Zap className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <p className="text-gray-400">
                      {monthsList.length === 0 ? 'æ”¯å‡ºè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“' : 'ã“ã®æœˆã®æ”¯å‡ºè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'}
                    </p>
                    <p className="text-sm text-gray-400 mt-2">
                      âš¡ãƒœã‚¿ãƒ³ã§æ”¯å‡ºã‚’è¨˜éŒ²ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </p>
                  </div>
                ) : (
                  <>
                    {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
                    <div className="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl shadow-sm p-5 border border-teal-100">
                      <h3 className="text-sm text-teal-600 mb-2">
                        {selectedYear}å¹´{selectedMonthNum}æœˆã®æ”¯å‡ºåˆè¨ˆ
                      </h3>
                      <p className="text-3xl font-bold text-teal-600 mb-2">
                        Â¥{totalExpenses.toLocaleString()}
                      </p>
                      <p className="text-xs text-teal-500">
                        {bucketExpenses.reduce((sum, b) => sum + b.count, 0)}å›ã®æ”¯å‡º
                      </p>
                    </div>
                    
                    {/* ãƒã‚±ãƒ„åˆ¥æ”¯å‡º */}
                    <div className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                      <h3 className="font-semibold text-gray-600 mb-4">ãƒã‚±ãƒ„åˆ¥æ”¯å‡º</h3>
                      <div className="space-y-4">
                        {bucketExpenses.map((bucket, index) => {
                          const percentage = (bucket.total / totalExpenses) * 100;
                          return (
                            <div key={index}>
                              <div className="flex justify-between items-center mb-2">
                                <div className="flex-1">
                                  <p className="font-medium text-gray-700">{bucket.bucketName}</p>
                                  <p className="text-xs text-gray-400">{bucket.accountName}</p>
                                </div>
                                <div className="text-right">
                                  <p className="font-semibold text-teal-600">
                                    Â¥{bucket.total.toLocaleString()}
                                  </p>
                                  <p className="text-xs text-gray-500">{bucket.count}å›</p>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                                  <div
                                    className="h-full bg-gradient-to-r from-teal-400 to-cyan-400"
                                    style={{ width: `${percentage}%` }}
                                  />
                                </div>
                                <span className="text-xs text-gray-500 w-12 text-right">
                                  {percentage.toFixed(0)}%
                                </span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* æ”¯å‡ºå±¥æ­´è©³ç´° */}
                    <div className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                      <h3 className="font-semibold text-gray-600 mb-4">æ”¯å‡ºå±¥æ­´</h3>
                      <div className="space-y-2">
                        {bucketExpenses.flatMap(bucket =>
                          bucket.history.map(h => ({
                            ...h,
                            bucketName: bucket.bucketName,
                            accountName: bucket.accountName,
                          }))
                        )
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .map(h => {
                          const date = new Date(h.date);
                          return (
                            <div key={h.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                              <div className="flex-1">
                                <p className="text-sm font-medium text-gray-700">{h.bucketName}</p>
                                <div className="flex items-center gap-2 mt-1">
                                  <p className="text-xs text-gray-400">
                                    {date.toLocaleDateString('ja-JP')}
                                  </p>
                                  {h.memo && (
                                    <p className="text-xs text-gray-500">Â· {h.memo}</p>
                                  )}
                                </div>
                              </div>
                              <p className="font-semibold text-teal-600">
                                Â¥{Number(h.amount).toLocaleString()}
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </>
                )}
              </>
            );
          })()}
        </div>
      )}
    </div>
  );
}

// ========================================
// è¨­å®šç”»é¢
// ========================================
function SettingsScreen({ data, setData, payday }) {
  const [tempPaydayDate, setTempPaydayDate] = useState(data.settings?.paydayDate || '');
  const [showResetConfirm, setShowResetConfirm] = useState(null);

  const toggleSetting = (key) => {
    setData({
      ...data,
      historySettings: {
        ...data.historySettings,
        [key]: !data.historySettings[key],
      },
    });
  };

  const toggleShowDailyBudget = () => {
    setData({
      ...data,
      settings: {
        ...data.settings,
        showDailyBudget: !data.settings?.showDailyBudget,
      },
    });
  };

  const savePaydayDate = () => {
    const date = Number(tempPaydayDate);
    if (date >= 1 && date <= 31) {
      payday.updatePaydayDate(date);
    }
  };

  const executeReset = async (type) => {
    if (type === 'history') {
      setData({ ...data, monthlySnapshots: [], balanceHistory: [] });
    } else if (type === 'amounts') {
      const resetData = {
        ...data,
        monthlyIncome: '',
        accounts: data.accounts.map(acc => ({
          ...acc,
          buckets: acc.buckets.map(b => ({ ...b, balance: '' })),
        })),
        fixedExpenses: data.fixedExpenses.map(e => ({ ...e, amount: '' })),
        savings: data.savings.map(s => ({
          ...s,
          monthlyAmount: '',
          currentAmount: '',
          targetAmount: '',
        })),
      };
      setData(resetData);
    } else if (type === 'all') {
      const freshData = {
        monthlyIncome: '',
        accounts: [],
        fixedExpenses: [],
        savings: [],
        monthlySnapshots: [],
        balanceHistory: [],
        historySettings: {
          trackBalanceHistory: false,
          trackMonthlySnapshots: false,
        },
        settings: {
          paydayDate: null,
          lastPaydayCheck: null,
          showDailyBudget: true,
        },
      };
      setData(freshData);
    }
    setShowResetConfirm(null);
  };

  return (
    <div className="space-y-4">
      <h1 className="text-2xl font-bold text-gray-600">è¨­å®š</h1>

      {/* çµ¦æ–™æ—¥è¨­å®š */}
      <section className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
        <div className="flex items-center gap-2 mb-4">
          <Calendar className="w-5 h-5 text-slate-500" />
          <h2 className="text-lg font-semibold text-gray-600">çµ¦æ–™æ—¥è¨­å®š</h2>
        </div>
        
        {data.settings?.paydayDate && (
          <div className="bg-sky-50 rounded-lg p-4 mb-4 border border-sky-100">
            <p className="text-sm text-sky-600 mb-1">ç¾åœ¨ã®çµ¦æ–™æ—¥</p>
            <p className="text-2xl font-bold text-sky-600 mb-2">
              {data.settings?.paydayType === 'lastBusinessDay' 
                ? 'æœˆæœ«æœ€çµ‚å¹³æ—¥' 
                : `æ¯æœˆ ${data.settings.paydayDate} æ—¥`}
            </p>
            {payday.nextPayday && (
              <p className="text-sm text-sky-600">
                æ¬¡å›: {payday.nextPayday.toLocaleDateString('ja-JP')}
                {payday.getDaysUntilNextPayday() > 0 && 
                  ` (ã‚ã¨${payday.getDaysUntilNextPayday()}æ—¥)`}
              </p>
            )}
          </div>
        )}

        {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-600 mb-3">ã‚ˆãã‚ã‚‹çµ¦æ–™æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
          <div className="grid grid-cols-3 gap-2">
            {[
              { value: '10', label: '10æ—¥', type: 'fixed' },
              { value: '15', label: '15æ—¥', type: 'fixed' },
              { value: '20', label: '20æ—¥', type: 'fixed' },
              { value: '25', label: '25æ—¥', type: 'fixed' },
              { value: '31', label: 'æœˆæœ«', type: 'fixed' },
              { value: 'lastBusiness', label: 'æœˆæœ«æœ€çµ‚å¹³æ—¥', type: 'lastBusinessDay' },
            ].map(template => {
              const isSelected = 
                (template.type === 'lastBusinessDay' && data.settings?.paydayType === 'lastBusinessDay') ||
                (template.type === 'fixed' && data.settings?.paydayType !== 'lastBusinessDay' && tempPaydayDate === template.value);
              
              return (
                <button
                  key={template.value}
                  onClick={() => {
                    if (template.type === 'lastBusinessDay') {
                      setTempPaydayDate('31');
                      setData({
                        ...data,
                        settings: {
                          ...data.settings,
                          paydayDate: '31',
                          paydayType: 'lastBusinessDay',
                          lastPaydayCheck: null,
                        },
                      });
                    } else {
                      setTempPaydayDate(template.value);
                      setData({
                        ...data,
                        settings: {
                          ...data.settings,
                          paydayDate: template.value,
                          paydayType: 'fixed',
                          lastPaydayCheck: null,
                        },
                      });
                    }
                  }}
                  className={`px-3 py-2.5 rounded-lg border-2 transition text-sm font-medium ${
                    isSelected
                      ? 'border-sky-400 bg-sky-50 text-sky-600'
                      : 'border-gray-200 hover:border-gray-300 text-gray-600'
                  }`}
                >
                  {template.label}
                </button>
              );
            })}
          </div>
        </div>

        {/* ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ› */}
        <div>
          <label className="block text-sm font-medium text-gray-600 mb-2">
            ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆ1ã€œ31æ—¥ï¼‰
          </label>
          <div className="flex gap-2 items-center">
            <span className="text-gray-500">æ¯æœˆ</span>
            <input
              type="number"
              min="1"
              max="31"
              value={tempPaydayDate}
              onChange={(e) => setTempPaydayDate(e.target.value)}
              placeholder="25"
              className="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-300"
            />
            <span className="text-gray-500">æ—¥</span>
            <button
              onClick={savePaydayDate}
              className="px-4 py-2 bg-sky-300 text-white rounded-lg hover:bg-sky-400 transition"
            >
              ä¿å­˜
            </button>
          </div>
        </div>

        <div className="bg-blue-50 rounded-lg p-4 mt-4 flex gap-3 border border-blue-100">
          <Info className="w-5 h-5 text-blue-400 flex-shrink-0" />
          <p className="text-sm text-gray-600">
            çµ¦æ–™æ—¥ã«æœˆæ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ã€æ‰‹å–ã‚Šãƒªã‚»ãƒƒãƒˆã€è²¯é‡‘é€²æ—æ›´æ–°ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
          </p>
        </div>
      </section>

      {/* è¡¨ç¤ºè¨­å®š */}
      <section className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
        <h2 className="text-lg font-semibold text-gray-600 mb-4">è¡¨ç¤ºè¨­å®š</h2>
        <div className="space-y-3">
          <label className="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer border border-gray-100">
            <span className="text-gray-600">1æ—¥ã‚ãŸã‚Šä½¿ãˆã‚‹é‡‘é¡ã‚’è¡¨ç¤º</span>
            <input
              type="checkbox"
              checked={data.settings?.showDailyBudget !== false}
              onChange={toggleShowDailyBudget}
              className="w-5 h-5 text-slate-500"
            />
          </label>
        </div>
      </section>

      {/* å±¥æ­´è¨­å®š */}
      <section className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
        <h2 className="text-lg font-semibold text-gray-600 mb-4">å±¥æ­´è¨­å®š</h2>
        <div className="space-y-3">
          <label className="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer border border-gray-100">
            <span className="text-gray-600">æœˆæ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¨˜éŒ²</span>
            <input
              type="checkbox"
              checked={data.historySettings?.trackMonthlySnapshots}
              onChange={() => toggleSetting('trackMonthlySnapshots')}
              className="w-5 h-5 text-slate-500"
            />
          </label>
          <label className="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer border border-gray-100">
            <span className="text-gray-600">æ®‹é«˜å±¥æ­´ã‚’è¨˜éŒ²</span>
            <input
              type="checkbox"
              checked={data.historySettings?.trackBalanceHistory}
              onChange={() => toggleSetting('trackBalanceHistory')}
              className="w-5 h-5 text-slate-500"
            />
          </label>
        </div>
      </section>

      {/* ãƒªã‚»ãƒƒãƒˆ */}
      <section className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
        <h2 className="text-lg font-semibold text-gray-600 mb-4">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h2>
        <div className="space-y-2">
          <button
            onClick={() => setShowResetConfirm('history')}
            className="w-full p-3 text-left border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600"
          >
            å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒªã‚»ãƒƒãƒˆ
          </button>
          <button
            onClick={() => setShowResetConfirm('amounts')}
            className="w-full p-3 text-left border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600"
          >
            é‡‘é¡ã®ã¿ãƒªã‚»ãƒƒãƒˆ
          </button>
          <button
            onClick={() => setShowResetConfirm('all')}
            className="w-full p-3 text-left border border-red-300 text-red-500 rounded-lg hover:bg-red-50"
          >
            ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </section>

      {/* ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦ */}
      <section className="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
        <h2 className="text-lg font-semibold text-gray-600 mb-4">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h2>
        <div className="space-y-4">
          <div className="flex items-center justify-between py-2 border-b border-gray-100">
            <span className="text-sm text-gray-600">ã‚¢ãƒ—ãƒªå</span>
            <span className="text-sm font-semibold text-gray-700">Money Map</span>
          </div>
          <div className="flex items-center justify-between py-2 border-b border-gray-100">
            <span className="text-sm text-gray-600">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
            <span className="text-sm font-semibold text-gray-700">1.0.0</span>
          </div>
          <div className="py-3 border-b border-gray-100">
            <p className="text-xs text-gray-500 mb-2">é–‹ç™ºã«ã¤ã„ã¦</p>
            <p className="text-sm text-gray-700 leading-relaxed">
              ã“ã®ã‚¢ãƒ—ãƒªã¯Claude AIï¼ˆAnthropicï¼‰ã‚’æ´»ç”¨ã—ã¦é–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚
            </p>
          </div>
          <div className="py-3 border-b border-gray-100">
            <p className="text-xs text-gray-500 mb-2">ä½¿ç”¨æŠ€è¡“</p>
            <div className="space-y-1">
              <p className="text-sm text-gray-700">â€¢ React 18.2.0 (MIT License)</p>
              <p className="text-sm text-gray-700">â€¢ Tailwind CSS (MIT License)</p>
              <p className="text-sm text-gray-700">â€¢ Babel Standalone</p>
            </div>
          </div>
          <div className="py-3">
            <p className="text-xs text-gray-500 mb-2">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</p>
            <p className="text-sm text-gray-700 leading-relaxed">
              å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãŠä½¿ã„ã®ç«¯æœ«å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚
            </p>
          </div>
          <div className="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg p-4 text-center border border-orange-100">
            <p className="text-sm font-semibold text-orange-600 mb-1">ğŸ’° Money Map</p>
            <p className="text-xs text-orange-500">ã‚ãªãŸã®ãŠé‡‘ã®åœ°å›³</p>
            <p className="text-xs text-gray-500 mt-2">Â© 2025 Money Map</p>
          </div>
        </div>
      </section>

      {/* ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showResetConfirm && (
        <ConfirmModal
          title="ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ"
          message={
            showResetConfirm === 'history'
              ? 'å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'
              : showResetConfirm === 'amounts'
              ? 'å…¨ã¦ã®é‡‘é¡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'
              : 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'
          }
          onConfirm={() => executeReset(showResetConfirm)}
          onCancel={() => setShowResetConfirm(null)}
        />
      )}
    </div>
  );
}

// ========================================
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
// ========================================
function MonthlyResetModal({ data, onClose, onConfirm }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div className="bg-gradient-to-r from-sky-100 to-blue-100 p-6 rounded-t-xl border-b border-sky-200">
          <div className="flex items-center gap-3 mb-2">
            <Calendar className="w-6 h-6 text-sky-600" />
            <h2 className="text-xl font-bold text-sky-700">çµ¦æ–™æ—¥ã§ã™ï¼</h2>
          </div>
          <p className="text-sky-600">ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™</p>
        </div>
        <div className="p-6 space-y-4">
          <div className="space-y-3">
            <h3 className="font-semibold text-gray-600">å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†</h3>
            <ul className="space-y-2 text-sm text-gray-500">
              <li className="flex items-start gap-2">
                <span className="text-slate-500 font-bold">1.</span>
                <span>æœˆæ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ 
                  {data.historySettings?.trackMonthlySnapshots ? ' (æœ‰åŠ¹)' : ' (ç„¡åŠ¹)'}
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-slate-500 font-bold">2.</span>
                <span>æ‰‹å–ã‚Šé‡‘é¡ãƒªã‚»ãƒƒãƒˆ</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-slate-500 font-bold">3.</span>
                <span>è²¯é‡‘é€²æ—ã®è‡ªå‹•æ›´æ–°</span>
              </li>
            </ul>
          </div>
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p className="text-sm text-gray-600">
              <strong className="text-yellow-700">æ³¨æ„:</strong> 
              å£åº§æ®‹é«˜ã¨ãƒã‚±ãƒ„ã®é‡‘é¡ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“
            </p>
          </div>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            å¾Œã§
          </button>
          <button
            onClick={onConfirm}
            className="flex-1 px-4 py-2 bg-sky-300 text-white rounded-lg hover:bg-sky-400 font-semibold"
          >
            ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
          </button>
        </div>
      </div>
    </div>
  );
}

function QuickExpenseModal({ amount, setAmount, selectedBucket, setSelectedBucket, bucketList, onClose, onSubmit }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div className="bg-gradient-to-r from-rose-100 to-pink-100 p-6 rounded-t-xl border-b border-rose-200">
          <div className="flex items-center gap-3 mb-2">
            <Zap className="w-6 h-6 text-rose-500" />
            <h2 className="text-xl font-bold text-rose-700">ã‚¯ã‚¤ãƒƒã‚¯æ”¯å‡ºç™»éŒ²</h2>
          </div>
          <p className="text-rose-600 text-sm">ãƒã‚±ãƒƒãƒˆä»£ã‚„çªç™ºçš„ãªæ”¯å‡ºã‚’ã‚µãƒƒã¨è¨˜éŒ²</p>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ä½¿ã£ãŸé‡‘é¡</label>
            <div className="flex items-center gap-2">
              <span className="text-gray-500">Â¥</span>
              <input
                type="number"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="5000"
                className="flex-1 px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-400"
                autoFocus
              />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">
              ã©ã®ãƒã‚±ãƒ„ã‹ã‚‰ä½¿ã†ï¼Ÿ
            </label>
            {bucketList.length === 0 ? (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-gray-600">
                ãƒã‚±ãƒ„ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«å£åº§ã¨ãƒã‚±ãƒ„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
              </div>
            ) : (
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {bucketList.map(bucket => (
                  <button
                    key={`${bucket.accountId}-${bucket.bucketId}`}
                    onClick={() => setSelectedBucket(bucket)}
                    className={`w-full text-left p-3 rounded-lg border-2 transition ${
                      selectedBucket?.bucketId === bucket.bucketId
                        ? 'border-rose-400 bg-rose-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="font-medium text-gray-600">{bucket.bucketName}</p>
                        <p className="text-xs text-gray-400">{bucket.accountName}</p>
                      </div>
                      <p className="text-sm font-semibold text-gray-600">
                        Â¥{Number(bucket.balance).toLocaleString()}
                      </p>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
          {amount && selectedBucket && (
            <div className="bg-blue-50 rounded-lg p-4 border border-blue-100">
              <p className="text-sm font-medium text-gray-600 mb-1">ä½¿ç”¨å¾Œã®æ®‹é«˜</p>
              <p className="text-2xl font-bold text-slate-600">
                Â¥{(Number(selectedBucket.balance) - Number(amount)).toLocaleString()}
              </p>
            </div>
          )}
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={onSubmit}
            disabled={!amount || !selectedBucket}
            className="flex-1 px-4 py-2 bg-gradient-to-r from-rose-300 to-pink-300 text-white rounded-lg hover:from-rose-400 hover:to-pink-400 transition font-semibold disabled:opacity-50"
          >
            ç™»éŒ²
          </button>
        </div>
      </div>
    </div>
  );
}

function FixedExpenseModal({ expense, data, setData, onClose }) {
  const [name, setName] = useState(expense.name || '');
  const [amount, setAmount] = useState(expense.amount || '');
  const [payFrom, setPayFrom] = useState(expense.payFrom || 'income');
  const [endDate, setEndDate] = useState(expense.endDate || '');
  const [hasEndDate, setHasEndDate] = useState(!!expense.endDate);

  // ãƒã‚±ãƒ„ä¸€è¦§ã‚’å–å¾—
  const bucketOptions = [];
  data.accounts?.forEach(account => {
    account.buckets?.forEach(bucket => {
      bucketOptions.push({
        value: `${account.id}:${bucket.id}`,
        label: `${account.name} - ${bucket.name}`,
      });
    });
  });

  const handleSave = () => {
    if (!name || !amount) return;

    const expenseData = {
      name,
      amount,
      payFrom,
      endDate: hasEndDate ? endDate : null,
    };

    if (expense.id) {
      const updated = data.fixedExpenses.map(e =>
        e.id === expense.id ? { ...e, ...expenseData } : e
      );
      setData({ ...data, fixedExpenses: updated });
    } else {
      const newExpense = { id: Date.now().toString(), ...expenseData };
      setData({ ...data, fixedExpenses: [...data.fixedExpenses, newExpense] });
    }
    onClose();
  };

  const handleDelete = () => {
    const updated = data.fixedExpenses.filter(e => e.id !== expense.id);
    setData({ ...data, fixedExpenses: updated });
    onClose();
  };

  // æ®‹ã‚ŠæœŸé–“ã‚’è¨ˆç®—
  const calculateRemainingMonths = () => {
    if (!endDate) return null;
    const today = new Date();
    const end = new Date(endDate);
    const diffTime = end - today;
    const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));
    return diffMonths > 0 ? diffMonths : 0;
  };

  const remainingMonths = calculateRemainingMonths();

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full" style={{ maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
        <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-t-xl border-b border-purple-100" style={{ flexShrink: 0 }}>
          <h2 className="text-xl font-bold text-purple-600">
            {expense.id ? 'å›ºå®šè²»ã‚’ç·¨é›†' : 'å›ºå®šè²»ã‚’è¿½åŠ '}
          </h2>
        </div>
        <div className="p-6 space-y-4" style={{ overflowY: 'auto', flex: 1 }}>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">åå‰</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="å®¶è³ƒ"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">é‡‘é¡</label>
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder="50000"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">æ”¯æ‰•å…ƒ</label>
            <select
              value={payFrom}
              onChange={(e) => setPayFrom(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400"
            >
              <option value="income">æ‰‹å–ã‚Šã‹ã‚‰</option>
              {bucketOptions.length > 0 && (
                <optgroup label="ãƒã‚±ãƒ„ã‹ã‚‰">
                  {bucketOptions.map(option => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </optgroup>
              )}
            </select>
          </div>

          {/* çµ‚äº†æ—¥è¨­å®š */}
          <div className="border-t border-gray-200 pt-4">
            <div className="flex items-center gap-2 mb-3">
              <input
                type="checkbox"
                id="hasEndDate"
                checked={hasEndDate}
                onChange={(e) => {
                  setHasEndDate(e.target.checked);
                  if (!e.target.checked) setEndDate('');
                }}
                className="w-4 h-4 text-purple-500 rounded focus:ring-purple-400"
              />
              <label htmlFor="hasEndDate" className="text-sm font-medium text-gray-600">
                çµ‚äº†æ—¥ã‚’è¨­å®šï¼ˆãƒ­ãƒ¼ãƒ³ãƒ»åˆ†å‰²æ‰•ã„ãªã©ï¼‰
              </label>
            </div>

            {hasEndDate && (
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-2">
                  ã„ã¤ã¾ã§ç¶šãï¼Ÿ
                </label>
                <input
                  type="date"
                  value={endDate}
                  onChange={(e) => setEndDate(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400"
                />
                {remainingMonths !== null && endDate && (
                  <p className="mt-2 text-sm text-purple-600">
                    {remainingMonths > 0 
                      ? `å®Œæ¸ˆã¾ã§ã‚ã¨ç´„${remainingMonths}ãƒ¶æœˆ`
                      : 'æ”¯æ‰•ã„å®Œäº†äºˆå®šæ—¥ã‚’éãã¦ã„ã¾ã™'}
                  </p>
                )}
              </div>
            )}
          </div>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3" style={{ flexShrink: 0 }}>
          {expense.id && (
            <button
              onClick={handleDelete}
              className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg"
            >
              å‰Šé™¤
            </button>
          )}
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={handleSave}
            className="flex-1 px-4 py-2 bg-purple-300 text-white rounded-lg hover:bg-purple-400 font-semibold"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
}

function SavingModal({ saving, data, setData, onClose }) {
  const [name, setName] = useState(saving.name || '');
  const [monthlyAmount, setMonthlyAmount] = useState(saving.monthlyAmount || '');
  const [targetAmount, setTargetAmount] = useState(saving.targetAmount || '');
  const [currentAmount, setCurrentAmount] = useState(saving.currentAmount || '0');
  const [payFrom, setPayFrom] = useState(saving.payFrom || 'income');
  const [saveTo, setSaveTo] = useState(saving.saveTo || '');
  const [category, setCategory] = useState(saving.category || 'other');

  // ãƒã‚±ãƒ„ä¸€è¦§ã‚’å–å¾—
  const bucketOptions = [];
  data.accounts?.forEach(account => {
    account.buckets?.forEach(bucket => {
      bucketOptions.push({
        value: `${account.id}:${bucket.id}`,
        label: `${account.name} - ${bucket.name}`,
      });
    });
  });

  const handleSave = () => {
    if (!name || !monthlyAmount || !targetAmount) return;

    if (saving.id) {
      const updated = data.savings.map(s =>
        s.id === saving.id
          ? { ...s, name, monthlyAmount, targetAmount, currentAmount, payFrom, saveTo, category }
          : s
      );
      setData({ ...data, savings: updated });
    } else {
      const newSaving = {
        id: Date.now().toString(),
        name,
        monthlyAmount,
        targetAmount,
        currentAmount,
        payFrom,
        saveTo,
        category,
      };
      setData({ ...data, savings: [...data.savings, newSaving] });
    }
    onClose();
  };

  const handleDelete = () => {
    const updated = data.savings.filter(s => s.id !== saving.id);
    setData({ ...data, savings: updated });
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full" style={{ maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
        <div className="p-6 border-b border-gray-200" style={{ flexShrink: 0 }}>
          <h2 className="text-xl font-bold text-gray-600">
            {saving.id ? 'è²¯é‡‘ç›®æ¨™ã‚’ç·¨é›†' : 'è²¯é‡‘ç›®æ¨™ã‚’è¿½åŠ '}
          </h2>
        </div>
        <div className="p-6 space-y-4" style={{ overflowY: 'auto', flex: 1 }}>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
            <div className="grid grid-cols-2 gap-2">
              {Object.keys(SAVING_CATEGORIES).map(key => {
                const cat = SAVING_CATEGORIES[key];
                const CategoryIcon = cat.icon;
                return (
                  <button
                    key={key}
                    onClick={() => setCategory(key)}
                    className={`p-3 rounded-lg border-2 transition flex items-center gap-2 ${
                      category === key
                        ? `${cat.borderColor} ${cat.bgColor}`
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <CategoryIcon className={`w-4 h-4 ${category === key ? cat.textColor : 'text-gray-400'}`} />
                    <span className={`text-sm font-medium ${category === key ? cat.textColor : 'text-gray-600'}`}>
                      {cat.name}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">åå‰</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="æ—…è¡Œè³‡é‡‘"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">æœˆæ¬¡ç©ç«‹é¡</label>
            <input
              type="number"
              value={monthlyAmount}
              onChange={(e) => setMonthlyAmount(e.target.value)}
              placeholder="10000"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ç›®æ¨™é‡‘é¡</label>
            <input
              type="number"
              value={targetAmount}
              onChange={(e) => setTargetAmount(e.target.value)}
              placeholder="100000"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ç¾åœ¨ã®ç©ç«‹é¡</label>
            <input
              type="number"
              value={currentAmount}
              onChange={(e) => setCurrentAmount(e.target.value)}
              placeholder="0"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ã©ã“ã‹ã‚‰å¼•ãï¼Ÿ</label>
            <select
              value={payFrom}
              onChange={(e) => setPayFrom(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            >
              <option value="income">æ‰‹å–ã‚Šã‹ã‚‰</option>
              {bucketOptions.length > 0 && (
                <optgroup label="ãƒã‚±ãƒ„ã‹ã‚‰">
                  {bucketOptions.map(option => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </optgroup>
              )}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ã©ã“ã«è²¯ã‚ã‚‹ï¼Ÿ</label>
            <select
              value={saveTo}
              onChange={(e) => setSaveTo(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
            >
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {bucketOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3" style={{ flexShrink: 0 }}>
          {saving.id && (
            <button
              onClick={handleDelete}
              className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg"
            >
              å‰Šé™¤
            </button>
          )}
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={handleSave}
            className="flex-1 px-4 py-2 bg-sky-400 text-white rounded-lg hover:bg-sky-500 font-semibold"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
}

function AccountModal({ account, data, setData, onClose }) {
  const [name, setName] = useState(account.name || '');

  const handleSave = () => {
    if (!name) return;

    if (account.id) {
      const updated = data.accounts.map(a => {
        if (a.id === account.id) {
          return { ...a, name };
        }
        return a;
      });
      setData({ ...data, accounts: updated });
    } else {
      const newAccount = { 
        id: Date.now().toString(), 
        name, 
        buckets: [],
      };
      setData({ ...data, accounts: [...data.accounts, newAccount] });
    }
    onClose();
  };

  const handleDelete = () => {
    const updated = data.accounts.filter(a => a.id !== account.id);
    setData({ ...data, accounts: updated });
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div className="p-6 space-y-4">
          <h2 className="text-xl font-bold text-gray-600">
            {account.id ? 'å£åº§ã‚’ç·¨é›†' : 'å£åº§ã‚’è¿½åŠ '}
          </h2>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">å£åº§å</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="ãƒ¡ã‚¤ãƒ³ãƒãƒ³ã‚¯"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-400"
            />
          </div>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
          {account.id && (
            <button
              onClick={handleDelete}
              className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg"
            >
              å‰Šé™¤
            </button>
          )}
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={handleSave}
            className="flex-1 px-4 py-2 bg-slate-400 text-white rounded-lg hover:bg-slate-500 font-semibold"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
}

function BucketModal({ bucket, accountId, data, setData, onClose }) {
  const [name, setName] = useState(bucket.name || '');
  const [balance, setBalance] = useState(bucket.balance || '');
  const [hasGoal, setHasGoal] = useState(!!bucket.goalAmount);
  const [goalAmount, setGoalAmount] = useState(bucket.goalAmount || '');
  const [goalDeadline, setGoalDeadline] = useState(bucket.goalDeadline || '');
  const [isSalaryBucket, setIsSalaryBucket] = useState(bucket.isSalaryBucket || false);

  const handleSave = () => {
    if (!name) return;

    const bucketData = {
      name,
      balance,
      goalAmount: hasGoal ? goalAmount : null,
      goalDeadline: hasGoal && goalDeadline ? goalDeadline : null,
      isSalaryBucket,
    };

    const updated = data.accounts.map(account => {
      if (account.id === accountId) {
        if (bucket.id) {
          return {
            ...account,
            buckets: account.buckets.map(b => {
              if (b.id === bucket.id) {
                return { ...b, ...bucketData };
              }
              // ä»–ã®ãƒã‚±ãƒ„ã®çµ¦ä¸å—å–ãƒ•ãƒ©ã‚°ã‚’è§£é™¤ï¼ˆ1ã¤ã®ãƒã‚±ãƒ„ã ã‘ãŒçµ¦ä¸å—å–ï¼‰
              if (isSalaryBucket && b.isSalaryBucket) {
                return { ...b, isSalaryBucket: false };
              }
              return b;
            }),
          };
        } else {
          const newBucket = { id: Date.now().toString(), ...bucketData };
          // æ–°è¦è¿½åŠ æ™‚ã‚‚ä»–ã®ãƒã‚±ãƒ„ã®çµ¦ä¸å—å–ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
          const updatedBuckets = isSalaryBucket
            ? account.buckets.map(b => ({ ...b, isSalaryBucket: false }))
            : account.buckets;
          return { ...account, buckets: [...updatedBuckets, newBucket] };
        }
      }
      // ä»–ã®å£åº§ã®ãƒã‚±ãƒ„ã®çµ¦ä¸å—å–ãƒ•ãƒ©ã‚°ã‚‚è§£é™¤ï¼ˆå…¨å£åº§ã§1ã¤ã ã‘ï¼‰
      if (isSalaryBucket) {
        return {
          ...account,
          buckets: account.buckets.map(b => ({ ...b, isSalaryBucket: false })),
        };
      }
      return account;
    });

    setData({ ...data, accounts: updated });
    onClose();
  };

  const handleDelete = () => {
    const updated = data.accounts.map(account => {
      if (account.id === accountId) {
        return {
          ...account,
          buckets: account.buckets.filter(b => b.id !== bucket.id),
        };
      }
      return account;
    });
    setData({ ...data, accounts: updated });
    onClose();
  };

  // æœˆæ¬¡ãƒšãƒ¼ã‚¹ã‚’è¨ˆç®—
  const calculateMonthlyPace = () => {
    if (!hasGoal || !goalAmount || !goalDeadline) return null;
    
    const today = new Date();
    const deadline = new Date(goalDeadline);
    const currentBalance = Number(balance) || 0;
    const target = Number(goalAmount);
    const remaining = target - currentBalance;
    
    if (remaining <= 0) return null;
    
    const monthsRemaining = Math.max(1, 
      (deadline.getFullYear() - today.getFullYear()) * 12 + 
      (deadline.getMonth() - today.getMonth())
    );
    
    return Math.ceil(remaining / monthsRemaining);
  };

  const monthlyPace = calculateMonthlyPace();
  const progress = hasGoal && goalAmount ? ((Number(balance) || 0) / Number(goalAmount)) * 100 : 0;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full" style={{ maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
        <div className="p-6 border-b border-gray-200" style={{ flexShrink: 0 }}>
          <h2 className="text-xl font-bold text-gray-600">
            {bucket.id ? 'ãƒã‚±ãƒ„ã‚’ç·¨é›†' : 'ãƒã‚±ãƒ„ã‚’è¿½åŠ '}
          </h2>
        </div>
        <div className="p-6 space-y-4" style={{ overflowY: 'auto', flex: 1 }}>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ãƒã‚±ãƒ„å</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="æ—…è¡Œè³‡é‡‘"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-400"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-2">ç¾åœ¨ã®æ®‹é«˜</label>
            <input
              type="number"
              value={balance}
              onChange={(e) => setBalance(e.target.value)}
              placeholder="50000"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-400"
            />
          </div>

          {/* ç›®æ¨™è¨­å®š */}
          <div className="border-t border-gray-200 pt-4">
            <div className="flex items-center gap-2 mb-3">
              <input
                type="checkbox"
                id="hasGoal"
                checked={hasGoal}
                onChange={(e) => {
                  setHasGoal(e.target.checked);
                  if (!e.target.checked) {
                    setGoalAmount('');
                    setGoalDeadline('');
                  }
                }}
                className="w-4 h-4 text-sky-400 rounded focus:ring-sky-400"
              />
              <label htmlFor="hasGoal" className="text-sm font-medium text-gray-600">
                è²¯é‡‘ç›®æ¨™ã‚’è¨­å®šã™ã‚‹
              </label>
            </div>

            {hasGoal && (
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    ç›®æ¨™é‡‘é¡
                  </label>
                  <input
                    type="number"
                    value={goalAmount}
                    onChange={(e) => setGoalAmount(e.target.value)}
                    placeholder="150000"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-2">
                    é”æˆäºˆå®šæœˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                  </label>
                  <input
                    type="month"
                    value={goalDeadline}
                    onChange={(e) => setGoalDeadline(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-400"
                  />
                </div>

                {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                {goalAmount && (
                  <div className="bg-sky-50 border border-sky-200 rounded-lg p-3">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-sm text-sky-600">é€²æ—</span>
                      <span className="text-sm font-bold text-sky-600">
                        {progress.toFixed(0)}%
                      </span>
                    </div>
                    <div className="w-full bg-white rounded-full h-2 mb-2">
                      <div
                        className="bg-gradient-to-r from-sky-400 to-blue-400 h-2 rounded-full transition-all"
                        style={{ width: `${Math.min(progress, 100)}%` }}
                      />
                    </div>
                    <div className="text-xs text-sky-600">
                      Â¥{Number(balance || 0).toLocaleString()} / Â¥{Number(goalAmount).toLocaleString()}
                    </div>
                    {monthlyPace && (
                      <div className="text-xs text-sky-600 mt-2">
                        æœˆ{monthlyPace.toLocaleString()}å††ãƒšãƒ¼ã‚¹ã§è²¯ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* çµ¦ä¸å—å–è¨­å®š */}
          <div className="border-t border-gray-200 pt-4">
            <label className="flex items-center gap-2 p-3 bg-emerald-50 rounded-lg cursor-pointer border border-emerald-100">
              <input
                type="checkbox"
                checked={isSalaryBucket}
                onChange={(e) => setIsSalaryBucket(e.target.checked)}
                className="w-5 h-5 text-emerald-500"
              />
              <div>
                <span className="text-gray-700 font-medium">çµ¦ä¸å—å–ãƒã‚±ãƒ„ã«è¨­å®š</span>
                <p className="text-xs text-gray-500 mt-1">
                  æ‰‹å–ã‚Šçµ¦æ–™ãŒã“ã®ãƒã‚±ãƒ„ã«è‡ªå‹•ã§å…¥é‡‘ã•ã‚Œã¾ã™
                </p>
              </div>
            </label>
          </div>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3" style={{ flexShrink: 0 }}>
          {bucket.id && (
            <button
              onClick={handleDelete}
              className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg"
            >
              å‰Šé™¤
            </button>
          )}
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={handleSave}
            className="flex-1 px-4 py-2 bg-slate-400 text-white rounded-lg hover:bg-slate-500 font-semibold"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
}

function ConfirmModal({ title, message, onConfirm, onCancel }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-sm w-full">
        <div className="p-6 space-y-4">
          <h2 className="text-xl font-bold text-gray-600">{title}</h2>
          <p className="text-gray-500">{message}</p>
        </div>
        <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
          <button
            onClick={onCancel}
            className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            onClick={onConfirm}
            className="flex-1 px-4 py-2 bg-red-400 text-white rounded-lg hover:bg-red-500 font-semibold"
          >
            å®Ÿè¡Œ
          </button>
        </div>
      </div>
    </div>
  );
}

MoneyMapApp;

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<MoneyMapApp/>);
</script>
</body>
</html>
<!--
================================================================================
Money Map - Personal Finance Tracker
================================================================================

Version: 1.0.0
Release Date: 2025-02-08

DEVELOPMENT:
This application was developed with the assistance of Claude AI by Anthropic.
https://www.anthropic.com

TECHNOLOGIES USED:
- React 18.2.0 (MIT License)
  Copyright (c) Meta Platforms, Inc. and affiliates.
  https://github.com/facebook/react
  
- Tailwind CSS (MIT License)
  Copyright (c) Tailwind Labs, Inc.
  https://tailwindcss.com
  
- Babel Standalone
  https://babeljs.io

LICENSES:
All libraries used in this application are distributed under the MIT License.
For full license texts, please visit the respective project repositories.

DATA PRIVACY:
All user data is stored locally on the device only.
No data is transmitted to external servers.

COPYRIGHT:
Â© 2025 Money Map. All rights reserved.

================================================================================
-->
